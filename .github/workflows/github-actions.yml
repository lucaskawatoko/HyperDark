name: Deploy Extension to Marketplace

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Verificar mudanÃ§as no package.json
        id: check_changes
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q "package.json"; then
            echo "âœ… package.json foi alterado, continuando o deploy..."
            echo "::set-output name=should_deploy::true"
          else
            echo "âš ï¸ Nenhuma alteraÃ§Ã£o em package.json. Deploy nÃ£o necessÃ¡rio."
            echo "::set-output name=should_deploy::false"
          fi

      - name: Finalizar workflow se nÃ£o houver mudanÃ§as
        if: steps.check_changes.outputs.should_deploy == 'false'
        run: |
          echo "âœ… Nenhuma mudanÃ§a detectada no package.json. Encerrando workflow."
          exit 0

      - name: Set up Node.js
        if: steps.check_changes.outputs.should_deploy == 'true'
        uses: actions/setup-node@v3
        with:
          node-version: 'latest'

      - name: Install dependencies
        if: steps.check_changes.outputs.should_deploy == 'true'
        run: npm install

      - name: Install VSCE
        if: steps.check_changes.outputs.should_deploy == 'true'
        run: npm install -g vsce semver auto-changelog

      - name: Check Version
        if: steps.check_changes.outputs.should_deploy == 'true'
        run: |
          PREV_VERSION=$(git describe --tags --abbrev=0 || echo "0.0.0")
          NEW_VERSION=$(node -p "require('./package.json').version")
          if [ "$(semver compare $NEW_VERSION $PREV_VERSION)" -le "0" ]; then
            echo "âŒ ERRO: A nova versÃ£o ($NEW_VERSION) deve ser maior que a anterior ($PREV_VERSION)"
            exit 1
          fi

      - name: Generate Changelog
        if: steps.check_changes.outputs.should_deploy == 'true'
        run: auto-changelog -p

      - name: Publish Extension
        if: steps.check_changes.outputs.should_deploy == 'true'
        run: vsce publish --pat ${{ secrets.VSCE_TOKEN }}

      - name: Create GitHub Release
        if: steps.check_changes.outputs.should_deploy == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: "Release v${{ github.run_number }}"
          body: "Confira as mudanÃ§as nesta versÃ£o ðŸš€"
          draft: false
          prerelease: false

      - name: Get Version from package.json
        id: get_version
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

      - name: Send Discord Webhook
        if: steps.check_changes.outputs.should_deploy == 'true'
        run: |
          curl -X POST -H "Content-Type: application/json" -d '{
            "content": "<@&1130581176290123866> ðŸš€ **Nova VersÃ£o Publicada!** (v${{ env.VERSION }})",
            "embeds": [{
              "title": "ðŸš€ Nova VersÃ£o Publicada! (v${{ env.VERSION }})",
              "description": "A nova versÃ£o **v${{ env.VERSION }}** da extensÃ£o **Flex Theme** jÃ¡ estÃ¡ disponÃ­vel!",
              "url": "https://marketplace.visualstudio.com/items?itemName=lucaskawatoko.hyperdark",
              "color": 000000,
              "fields": [
                {
                  "name": "ðŸ“¥ Instale no VS Code",
                  "value": "`lucaskawatoko.hyperdark`"
                }
              ],
              "footer": {
                "text": "Publicado automaticamente por GitHub Actions"
              }
            }]
          }' ${{ secrets.WEBHOOK_DISCORD }}

